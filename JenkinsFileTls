pipeline {
    agent any
    environment {
        KUBE_CONTEXT = 'your-kube-context'  // Kube context if you have multiple clusters
        KUBERNETES_NAMESPACE = 'default'  // Replace with your namespace
    }
    stages {
        stage('Check Secret and Ingress') {
            steps {
                script {
                    // Periksa keberadaan Secret aam-tls
                    def secretExists = sh(
                        script: "kubectl get secret aam-tls -o jsonpath='{.metadata.name}'",
                        returnStdout: true
                    ).trim()
                    
                    if (secretExists != 'aam-tls') {
                        error "Secret aam-tls tidak ditemukan!"
                    }

                    // Periksa isi Secret aam-tls
                    sh "kubectl describe secret aam-tls"

                    // Periksa apakah Ingress menggunakan Secret aam-tls
                    def ingressUsesSecret = sh(
                        script: "kubectl get ingress aam-ingress -o jsonpath='{.spec.tls[0].secretName}'",
                        returnStdout: true
                    ).trim()
                    
                    if (ingressUsesSecret != 'aam-tls') {
                        error "Ingress aam-ingress tidak menggunakan Secret aam-tls!"
                    }
                }
            }
        }
        stage('Test HTTPS Connection') {
            steps {
                script {
                    // Cek akses HTTPS ke domain
                    def domain = "https://devops-aam.dsam.web.id"
                    def curlOutput = sh(
                        script: "curl -k -o /dev/null -s -w '%{http_code}' $domain",
                        returnStdout: true
                    ).trim()

                    if (curlOutput != '200') {
                        error "Akses ke $domain tidak berhasil! Status: $curlOutput"
                    }

                    echo "HTTPS ke $domain berhasil!"
                }
            }
        }
    }
}